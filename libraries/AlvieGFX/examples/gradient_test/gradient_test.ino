/*
* Modified by Markus Lipp adding interleaved buffers, streaming, 32x32 & 24bit support
* Based on "_16x32_Matrix R3.0" by Creater Alex Medeiros, http://PenguinTech.tk
* Use code freely and distort its contents as much as you want, just remeber to thank the 
* original creaters of the code by leaving their information in the header. :)
*/


//PortC[0:11] = {15, 22, 23, 9, 10, 13, 11, 12, 28, 27, 29, 30}
//PortD[0:7] = {2, 14, 7, 8, 6, 20, 21, 5}
//Define pins
//const uint8_t
////PortC
//APIN      = 15, BPIN      = 22, CPIN      = 23, DPIN = 9,
//CLOCKPIN  = 10, LATCHPIN  = 13, OEPIN     = 11,
////PortD
//R1PIN     = 2, R2PIN     = 8,
//G1PIN     = 14, G2PIN     = 6,
//B1PIN     = 7, B2PIN     = 20;

//uint8_t pinTable[13] = {
//  R1PIN,R2PIN,G1PIN,G2PIN,B1PIN,B2PIN,
//  APIN,BPIN,CPIN,DPIN,CLOCKPIN,LATCHPIN,OEPIN};

////Addresses 1/8 rows Through a decoder
//uint16_t const A = 1, B = 2,C = 4, D=8;
////Acts like a 16 bit shift register
//uint16_t const SCLK   = 16;
//uint16_t const LATCH  = 32;
//uint16_t const OE     = 64;
//
//uint16_t const abcVar[16] = { //Decoder counter var
//  0,A,B,A+B,C,C+A,C+B,A+B+C,
//  0+D,A+D,B+D,A+B+D,C+D,C+A+D,C+B+D,A+B+C+D};
//
////Data Lines for row 1 red and row 9 red, ect.
//uint16_t const RED1   = 1, RED2   = 8;
//uint16_t const GREEN1 = 2, GREEN2 = 16;
//uint16_t const BLUE1  = 4, BLUE2  = 32;

#include "panel.h"
#include "Adafruit_GFX.h"
#include "AlvieGFX.h"

RGBPanel_class RGBPanel;

const uint8_t SIZEX = 32;
const uint8_t SIZEY = 32;

const unsigned char linearTable[256] = {
    0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2,
    2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 4, 4,
    4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 7,
    7, 7, 7, 8, 8, 8, 8, 9, 9, 9, 10, 10, 10, 10, 11,
    11, 11, 12, 12, 12, 13, 13, 13, 14, 14, 15, 15, 15,
    16, 16, 17, 17, 17, 18, 18, 19, 19, 20, 20, 21, 21,
    22, 22, 23, 23, 24, 24, 25, 25, 26, 26, 27, 28, 28,
    29, 29, 30, 31, 31, 32, 33, 33, 34, 35, 35, 36, 37,
    37, 38, 39, 40, 40, 41, 42, 43, 44, 44, 45, 46, 47,
    48, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 58,
    59, 60, 61, 62, 63, 65, 66, 67, 68, 69, 70, 71, 72,
    73, 74, 75, 77, 78, 79, 80, 81, 83, 84, 85, 86, 88,
    89, 90, 91, 93, 94, 95, 97, 98, 99, 101, 102, 104,
    105, 107, 108, 109, 111, 112, 114, 115, 117, 119,
    120, 122, 123, 125, 126, 128, 130, 131, 133, 135,
    136, 138, 140, 142, 143, 145, 147, 149, 151, 152,
    154, 156, 158, 160, 162, 164, 166, 168, 170, 171,
    173, 175, 178, 180, 182, 184, 186, 188, 190, 192,
    194, 196, 199, 201, 203, 205, 208, 210, 212, 214,
    217, 219, 221, 224, 226, 229, 231, 233, 236, 238,
    241, 243, 246, 248, 251, 253, 255
};

//BAM and interrupt variables
uint8_t rowN = 0;
uint16_t BAM;
uint8_t BAMMAX = 7; //now 24bit color! (0-7)


void setup() {
//  for(uint8_t i = 0; i < 13; i++){
//        pinMode(pinTable[i], OUTPUT);
//    }
//  timerInit();
  Serial.begin(250000); 
  
  RGBPanel.begin();
  RGBPanel.clear();
  RGBPanel.setApplyEnabled(true);
}

uint8_t r,g, prevVal,val;
int dataPos=0;

byte interleavedBuffer[] = {
0,0,48,63,63,63,63,56,56,56,48,63,63,59,57,61,53,57,29,24,8,63,47,31,63,8,47,47,15,15,63,63,0,0,16,16,16,31,24,24,23,31,31,31,31,23,29,52,52,45,44,31,8,31,8,8,8,40,15,40,63,24,63,7,0,0,48,48,56,48,55,56,56,63,48,55,48,53,63,53,21,43,27,31,40,56,15,24,31,40,63,63,24,8,0,0,0,0,16,16,16,24,16,31,31,31,16,24,23,17,27,61,61,45,29,63,47,8,15,31,24,8,47,31,15,15,7,7,0,0,16,16,16,16,24,24,16,24,31,23,23,19,29,60,61,45,24,24,15,40,24,63,8,47,31,8,15,8,7,56,0,0,48,48,48,48,48,48,56,56,48,56,48,56,61,21,29,60,62,8,40,31,15,63,56,24,8,15,15,8,56,63,0,0,48,48,48,48,48,48,48,
48,56,56,48,52,52,60,60,29,13,15,47,63,63,15,8,8,8,8,8,15,63,63,0,0,48,48,48,48,48,48,48,48,48,48,56,56,60,60,60,60,56,56,24,8,8,8,15,15,15,15,15,15,63,63,0,0,48,63,56,63,55,56,48,48,56,61,61,53,52,30,62,46,60,45,61,30,63,63,63,40,31,15,15,31,63,63,0,0,48,48,55,31,24,24,23,55,61,53,52,21,28,29,53,45,12,44,28,30,24,24,56,8,31,56,63,15,56,7,0,0,16,16,24,48,55,56,56,63,56,61,61,29,21,21,61,60,44,61,45,31,63,40,63,40,47,47,8,24,7,0,0,0,16,16,16,24,16,31,31,31,28,20,29,60,52,60,52,45,12,44,13,8,63,63,40,24,63,15,31,15,7,7,0,0,16,16,16,16,24,24,16,24,23,20,28,29,28,61,52,
29,61,60,29,58,56,15,56,47,31,24,15,8,7,56,0,0,16,16,16,16,16,16,24,24,20,28,28,20,29,61,60,60,13,60,44,25,47,47,24,24,8,15,15,8,56,63,0,0,48,48,48,48,48,48,48,48,56,60,60,52,52,20,29,29,29,44,44,60,31,31,8,8,8,8,8,15,63,63,0,0,48,48,48,48,48,48,48,48,48,52,52,60,60,60,60,60,60,29,29,13,8,8,15,15,15,15,15,15,63,63,0,0,48,31,16,23,31,16,23,20,28,23,21,31,63,55,62,23,62,60,15,45,13,43,15,24,31,47,47,31,63,63,0,0,16,16,23,31,16,16,19,20,21,52,62,54,54,23,62,31,31,47,28,28,12,31,8,63,56,15,24,15,56,7,0,0,16,48,24,16,23,24,20,20,20,60,52,29,61,53,60,28,44,60,61,12,12,9,63,
8,8,47,31,8,7,0,0,0,16,16,48,56,48,63,63,60,60,29,20,21,29,53,52,52,13,44,45,61,45,63,40,8,40,31,31,31,7,7,0,0,16,16,16,16,24,24,16,28,20,28,29,21,52,61,61,60,13,13,44,12,60,31,40,63,8,24,15,8,7,56,0,0,48,48,48,48,48,48,56,60,52,52,60,52,21,29,20,29,29,44,29,12,61,45,8,24,31,15,15,8,56,63,0,0,16,16,16,16,16,16,16,20,28,28,28,20,20,20,29,29,29,60,44,45,29,24,24,8,8,8,8,15,63,63,0,0,48,48,48,48,48,48,48,52,52,52,52,60,60,60,60,60,60,29,29,29,13,13,15,15,15,15,15,15,63,63,0,0,16,55,56,55,63,59,52,63,20,53,63,62,28,55,30,30,45,29,13,47,28,13,61,8,31,31,63,15,63,63,0,
0,16,16,31,23,24,19,22,52,54,21,52,30,60,61,21,20,61,15,12,15,62,9,9,31,8,15,24,15,56,7,0,0,48,48,48,48,63,50,60,20,61,62,31,55,29,21,28,28,29,47,31,13,28,45,13,24,24,47,31,8,7,0,0,0,0,48,48,56,56,56,52,52,52,53,52,60,62,22,55,22,14,29,13,28,29,25,41,24,56,15,15,15,7,7,0,0,0,16,16,16,16,28,20,28,20,28,21,52,61,20,21,21,60,29,61,29,61,9,57,63,8,8,31,24,7,56,0,0,0,16,16,16,16,16,28,28,20,20,28,61,61,28,20,29,60,44,29,12,61,61,9,24,31,31,15,8,56,63,0,0,0,16,16,16,16,20,20,20,28,28,28,60,60,21,29,29,60,60,44,45,29,29,29,8,8,8,8,15,63,63,0,0,0,48,48,48,48,48,52,
52,52,52,52,20,20,60,60,60,29,29,29,29,13,13,13,15,15,15,15,15,63,63,0,0,0,55,48,63,63,62,29,53,29,52,21,20,60,31,22,62,53,29,31,31,63,45,57,61,31,31,31,15,63,7,0,0,0,16,31,31,19,52,52,55,28,29,31,29,22,22,22,31,31,28,45,47,11,59,9,25,56,47,24,31,0,7,0,0,0,48,48,56,59,28,28,30,31,61,60,22,63,62,23,30,30,63,44,46,25,61,57,45,56,15,15,8,63,56,0,0,0,16,16,16,28,22,30,28,20,55,31,31,23,54,30,55,22,15,31,29,57,41,29,61,8,31,31,15,7,7,0,0,0,48,48,48,50,60,60,52,60,20,21,28,29,29,60,29,29,44,12,44,13,61,61,13,24,8,31,24,7,56,0,0,0,48,48,48,52,52,52,60,60,52,52,53,61,52,61,
53,60,29,12,61,45,25,13,9,31,31,15,8,56,63,0,0,0,48,48,48,48,52,52,52,52,60,60,60,60,53,53,61,60,60,61,13,13,29,25,25,8,8,8,15,63,63,0,0,0,16,16,16,20,20,20,20,20,20,20,20,20,28,28,28,29,29,29,29,29,13,13,13,15,15,15,15,63,63,0,0,0,55,24,62,30,63,63,21,62,63,54,28,22,54,62,30,28,47,63,44,45,47,25,29,29,63,15,63,63,7,0,0,0,16,23,20,20,22,21,23,61,20,61,61,54,52,52,53,63,46,28,13,9,29,15,57,29,31,8,63,0,0,0,0,0,48,16,56,54,52,52,63,30,30,29,31,31,52,20,60,62,61,28,46,25,11,13,29,41,15,31,0,63,63,0,0,0,48,16,49,60,52,60,54,63,22,61,61,28,31,62,23,52,29,45,63,27,41,25,
45,9,15,15,7,7,7,0,0,0,48,16,49,54,62,62,52,52,61,31,22,54,55,55,54,22,31,63,29,25,41,41,25,13,24,15,56,7,56,0,0,0,16,48,20,20,20,20,28,28,28,28,21,28,20,29,20,29,29,44,61,45,9,29,9,13,31,31,0,56,63,0,0,0,48,48,54,52,52,52,52,52,52,52,60,61,53,53,60,60,60,29,13,13,13,25,25,29,8,8,63,63,63,0,0,0,16,16,20,20,20,20,20,20,20,20,20,20,28,28,29,29,29,29,29,29,29,13,13,9,15,15,63,63,63,0,0,0,63,16,30,63,28,29,55,62,28,29,31,55,31,22,23,28,55,29,63,63,11,57,59,57,63,15,63,63,7,0,0,0,16,55,62,30,22,61,53,22,21,62,53,20,54,31,30,52,53,60,25,45,57,61,61,41,10,24,56,7,0,0,
0,0,32,16,22,30,31,55,28,54,23,53,31,21,61,20,61,60,62,60,41,27,9,27,41,25,29,31,7,63,63,0,0,0,48,48,54,54,62,22,31,52,60,22,54,21,28,61,20,52,23,47,25,59,15,45,9,29,29,31,7,7,7,0,0,0,32,16,22,22,22,30,30,55,55,62,55,20,28,29,29,61,62,14,15,45,61,29,9,9,29,15,56,7,56,0,0,0,48,16,20,20,20,20,20,60,60,61,53,30,31,23,30,55,60,61,45,25,13,25,25,13,30,31,0,56,63,0,0,0,0,48,52,52,52,52,52,20,20,20,28,61,61,53,52,28,29,29,29,13,9,25,25,29,13,8,63,63,63,0,0,0,16,16,20,20,20,20,20,20,20,20,20,20,20,28,29,29,29,29,29,29,29,13,13,9,9,15,63,63,63,0,0,0,63,22,29,55,61,30,
55,60,61,61,60,29,54,55,22,63,29,47,29,13,59,25,31,45,29,63,63,63,7,0,0,0,0,20,20,55,55,60,60,63,61,52,23,62,21,61,21,60,61,47,15,9,13,31,15,29,9,7,56,7,0,0,0,0,0,20,20,62,55,63,52,31,63,54,61,31,52,61,52,63,20,15,45,43,63,11,57,25,25,63,7,63,63,0,0,0,0,52,52,22,30,31,54,52,29,29,63,22,20,28,28,55,55,31,63,25,59,45,25,13,13,7,7,7,7,0,0,0,0,54,54,52,52,52,29,29,29,20,29,61,63,54,54,21,21,31,63,59,25,9,13,29,9,7,56,7,56,0,0,0,0,54,54,54,54,54,54,54,54,63,63,54,63,54,63,55,62,61,9,25,13,9,29,9,9,7,0,56,63,0,0,0,0,20,20,20,20,20,20,20,20,20,20,29,29,20,
20,28,29,29,29,13,9,9,29,29,29,56,63,63,63,0,0,0,0,20,20,20,20,20,20,20,20,20,20,20,20,29,29,29,29,29,29,29,29,29,9,9,9,63,63,63,63,0,0,0,63,4,54,21,30,53,61,22,52,20,54,30,28,29,30,23,61,55,61,27,41,47,11,29,13,62,63,63,7,0,0,0,0,62,55,62,53,20,30,54,60,23,63,28,63,30,63,63,55,23,57,47,9,25,57,27,9,4,56,7,56,0,0,0,0,36,54,55,62,22,52,22,62,63,63,62,60,29,62,20,54,29,11,61,9,45,11,9,25,61,7,63,63,0,0,0,0,4,22,22,23,30,63,52,21,55,52,30,21,60,22,23,53,55,25,59,45,15,29,9,9,1,7,7,7,0,0,0,0,60,22,22,22,23,55,62,62,52,62,22,21,29,31,30,62,57,45,15,31,29,
25,13,25,5,56,7,56,0,0,0,0,36,54,54,54,54,22,23,23,31,30,55,61,60,55,62,23,31,27,13,25,13,29,25,9,5,0,56,63,0,0,0,0,6,20,20,20,20,20,20,20,20,21,29,31,30,20,21,29,29,29,25,9,13,29,29,29,57,63,63,63,0,0,0,0,20,20,20,20,20,20,20,20,20,20,20,20,21,29,29,29,29,29,29,29,25,9,9,9,57,63,63,63,0,0,0,60,61,52,61,20,62,31,54,52,53,29,52,52,60,31,53,62,63,47,31,57,13,15,13,7,61,63,63,7,0,0,0,6,62,22,23,63,61,28,63,60,55,62,22,60,29,53,55,21,21,9,27,27,63,13,29,61,5,0,63,56,0,0,0,4,6,23,21,53,21,28,54,53,23,63,30,22,54,28,53,54,17,59,11,59,15,9,15,61,61,63,63,63,0,
0,0,6,4,52,52,21,20,20,63,54,21,29,55,61,52,60,31,21,19,59,59,29,15,31,9,1,1,7,7,7,0,0,0,6,6,54,54,54,55,54,20,29,53,52,52,62,62,54,53,53,51,25,27,27,9,13,25,61,1,56,7,56,0,0,0,4,4,20,20,20,20,21,21,21,29,28,21,20,29,20,28,21,31,27,13,25,29,9,25,61,5,0,56,63,0,0,0,6,6,22,22,22,22,22,22,22,22,23,31,30,30,23,23,31,29,29,25,9,13,13,29,1,57,63,63,63,0,0,0,4,4,20,20,20,20,20,20,20,20,20,20,21,21,29,29,29,29,29,29,29,25,25,9,57,57,63,63,63,0,0,0,62,62,60,52,53,61,30,22,55,63,52,30,55,22,63,53,53,31,25,63,25,27,9,41,5,61,59,63,7,0,0,0,4,61,5,20,52,21,
28,60,30,52,22,31,28,53,23,52,27,57,27,29,57,27,9,51,3,61,4,63,63,0,0,0,6,6,63,55,23,20,22,63,28,23,52,21,21,20,31,61,57,23,25,43,31,29,11,55,5,61,58,63,63,0,0,0,6,6,6,55,54,55,53,20,60,63,63,28,22,30,29,61,49,53,57,25,31,25,27,45,61,5,6,7,7,0,0,0,4,4,4,20,21,21,20,21,20,30,23,61,61,53,60,28,31,25,23,13,15,11,29,37,57,5,61,7,56,0,0,0,6,6,6,22,22,22,23,23,22,20,28,31,22,31,30,23,29,17,31,27,13,29,9,29,61,1,3,56,63,0,0,0,6,6,6,22,22,22,22,22,23,23,23,23,30,30,31,23,23,31,25,25,29,13,13,1,1,57,61,63,63,0,0,0,4,4,4,20,20,20,20,20,20,20,20,20,21,21,
21,29,29,29,29,29,25,25,25,57,57,57,57,63,63,0,0,1,60,61,60,62,23,54,29,20,21,29,54,62,60,21,63,29,55,63,63,45,29,31,59,63,3,61,57,63,7,0,0,4,6,63,6,63,23,55,55,52,21,52,60,31,29,52,29,29,49,31,51,11,27,15,43,3,3,61,5,56,63,0,0,6,4,4,60,61,53,20,21,29,61,63,55,22,29,28,23,21,59,57,25,31,29,31,55,3,5,61,61,56,63,0,0,0,4,4,5,5,20,20,21,21,29,23,21,52,52,60,55,61,17,31,27,27,29,25,27,57,57,1,5,0,7,0,0,0,4,4,4,4,21,20,20,21,20,31,22,30,20,28,31,23,17,29,27,25,25,31,17,5,57,5,57,0,56,0,0,0,4,4,4,4,20,21,21,21,20,22,31,30,21,20,30,23,31,29,23,27,15,25,
41,61,61,1,1,63,63,0,0,0,4,4,4,4,20,20,20,20,21,23,23,22,28,29,31,23,23,19,25,25,29,13,37,1,1,57,57,63,63,0,0,0,6,6,6,6,22,22,22,22,22,20,20,21,23,23,21,29,29,29,29,29,25,25,25,57,57,57,57,63,63,0,0,2,60,61,61,60,4,20,21,22,53,31,62,31,23,53,31,31,55,55,57,29,25,3,7,59,1,63,57,63,7,0,0,4,6,63,6,60,63,23,21,28,21,55,53,23,31,21,31,29,55,21,19,31,25,63,57,1,1,57,5,56,63,0,0,5,4,4,60,60,4,21,23,22,21,22,30,60,63,60,61,63,21,31,19,31,9,57,1,1,7,57,57,56,63,0,0,3,6,6,7,6,63,22,22,23,30,21,29,31,29,22,21,29,31,21,17,25,27,63,61,63,61,1,5,0,7,0,
0,4,6,6,6,7,7,22,23,22,23,30,31,20,30,31,22,25,25,27,29,23,9,3,63,1,61,5,57,0,56,0,0,6,4,4,4,4,4,21,21,20,20,21,21,28,29,20,29,29,19,29,17,31,31,1,5,61,57,1,1,63,63,0,0,4,4,4,4,4,4,20,20,21,21,21,21,20,20,29,29,29,23,19,27,29,29,5,1,1,1,57,57,63,63,0,0,6,6,6,6,6,6,22,22,22,22,22,22,23,23,23,23,23,29,29,29,25,25,57,57,57,57,57,57,63,63,0,0,6,63,62,61,60,4,61,61,28,28,23,28,60,53,61,51,53,19,19,31,31,7,7,5,63,5,61,57,63,7,0,0,4,6,62,7,63,61,7,7,23,22,22,29,21,31,22,21,25,29,31,31,43,57,59,57,7,3,63,5,56,7,0,0,6,4,5,60,60,5,60,
4,21,29,29,28,31,31,20,27,17,17,25,31,13,3,63,7,5,7,57,61,56,7,0,0,6,6,6,7,6,63,63,7,23,22,31,22,20,21,30,31,21,31,21,31,43,3,63,61,63,57,5,1,0,63,0,0,6,6,6,6,7,7,6,63,22,22,23,31,22,31,22,29,31,23,21,29,59,5,7,59,5,61,1,57,0,56,0,0,6,6,6,6,6,6,7,7,22,23,23,22,31,31,23,23,25,23,27,29,23,3,5,5,57,57,1,1,63,63,0,0,4,4,4,4,4,4,4,4,21,21,21,20,20,20,29,29,29,19,19,23,29,5,1,1,1,1,57,57,63,63,0,0,6,6,6,6,6,6,6,6,22,22,22,23,23,23,23,23,23,29,29,25,25,57,57,57,57,57,57,57,63,63,0,0,6,63,63,62,63,7,63,62,63,55,30,23,30,31,30,
23,31,19,3,61,3,7,1,3,57,5,57,57,63,7,0,0,6,6,62,6,63,63,6,7,6,30,30,20,31,20,23,19,27,23,33,57,63,63,57,61,5,3,63,61,0,7,0,0,6,6,7,63,62,7,63,7,62,22,22,29,30,30,23,25,31,29,41,7,63,3,57,3,7,7,61,57,0,7,0,0,4,4,4,5,4,61,61,5,4,61,28,23,29,28,20,23,19,25,23,61,3,3,57,57,59,61,1,1,56,63,0,0,6,6,6,6,7,7,6,63,63,62,22,31,31,23,23,27,19,25,33,3,63,1,5,59,5,57,1,57,0,56,0,0,4,4,4,4,4,4,5,5,4,5,20,20,21,28,21,23,25,29,27,61,59,3,7,5,57,57,1,1,63,63,0,0,6,6,6,6,6,6,6,6,7,7,22,22,22,23,31,29,29,25,59,63,61,5,1,
1,1,1,57,57,63,63,0,0,6,6,6,6,6,6,6,6,6,6,23,23,23,23,23,23,23,23,5,1,1,57,57,57,57,57,57,57,63,63,0,0,4,61,60,61,60,5,61,60,60,61,61,60,5,5,59,7,61,3,7,59,7,1,5,7,63,7,57,57,63,7,0,0,6,6,62,7,61,61,4,5,5,61,60,5,5,5,59,1,5,59,7,63,59,59,63,7,1,63,7,57,7,0,0,0,4,4,5,60,60,5,61,5,60,4,61,60,4,60,3,57,61,57,3,3,61,5,57,63,7,7,1,57,0,0,0,0,6,6,6,7,6,63,63,7,6,63,62,6,6,7,63,3,63,3,3,61,1,1,57,57,63,57,57,1,56,56,0,0,6,6,6,6,7,7,6,63,63,62,62,6,6,62,61,5,1,61,5,7,57,7,1,63,1,57,1,57,0,63,0,
0,6,6,6,6,6,6,7,7,6,7,6,63,6,63,63,1,7,1,63,57,57,7,7,1,57,57,1,1,63,63,0,0,6,6,6,6,6,6,6,6,7,7,6,6,7,7,7,63,57,57,63,63,63,1,1,1,1,1,57,57,63,63,0,0,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,1,1,1,57,57,57,57,57,57,57,63,63};


void loop() {  

            for (int y=0;y<RGBPanel.height();y++) {
                for (int x=0;x<RGBPanel.width(); x++) {
                    unsigned char r=interleavedBuffer[(x+y)];
                    unsigned char g=interleavedBuffer[(x+y)+1];
                    unsigned char b=interleavedBuffer[(x+y)+2];
                    RGBPanel.setPixel(x,y,r,g,b);
                }
            }
            RGBPanel.apply();
}

//IntervalTimer timer1;
//
//void timerInit() {
//    BAM = 0;
//    attackMatrix();
//}
//
//
////The updating matrix stuff happens here
////each pair of rows is taken through its BAM cycle
////then the rowNumber is increased and id done again
//void attackMatrix() {
//    timer1.end();    
//    
//    uint16_t portData;
//    portData = 0; // Clear data to enter
//    portData |= (abcVar[rowN]);//|OE; // abc, OE
//    portData &=~ LATCH;        //LATCH LOW
//    GPIOC_PDOR = portData;  // Write to Port
//    
//    uint8_t *start = &interleavedBuffer[rowN*SIZEX*8+((7-BAMMAX)+BAM)*32];    
//    for(uint8_t _x = 0; _x < 32; _x++){
//          GPIOD_PDOR = start[_x]; // Transfer data
//          GPIOC_PDOR |=  SCLK;// Clock HIGH
//          GPIOC_PDOR &=~ SCLK;// Clock LOW
//    }
//
//    GPIOC_PDOR |= LATCH;// Latch HIGH
//    GPIOC_PDOR &=~ OE;// OE LOW, Displays line
//
//    #define LOOPTIME 2 //trial&error to get both smooth gradients & little flicker
//    #define CALLOVERHEAD 2
//    timer1.begin(attackMatrix,((LOOPTIME+CALLOVERHEAD)<<BAM)-CALLOVERHEAD);
//  
//    if(BAM >= BAMMAX) { //Checks the BAM cycle for next time.    
//        if(rowN == 15){
//            rowN = 0;
//        } else {
//            rowN ++;
//        }        
//        BAM = 0;
//      } else {
//        BAM ++;
//    }
//}
